<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Regression in PySpark | Chan`s Jupyter</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Regression in PySpark" />
<meta name="author" content="Chanseok Kang" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Next you’ll learn to create Linear Regression models. You’ll also find out how to augment your data by engineering new predictors as well as a robust approach to selecting only the most relevant predictors. This is the Summary of lecture “Machine Learning with PySpark”, via datacamp." />
<meta property="og:description" content="Next you’ll learn to create Linear Regression models. You’ll also find out how to augment your data by engineering new predictors as well as a robust approach to selecting only the most relevant predictors. This is the Summary of lecture “Machine Learning with PySpark”, via datacamp." />
<link rel="canonical" href="https://goodboychan.github.io/python/datacamp/pyspark/2020/08/11/01-Regression-in-PySpark.html" />
<meta property="og:url" content="https://goodboychan.github.io/python/datacamp/pyspark/2020/08/11/01-Regression-in-PySpark.html" />
<meta property="og:site_name" content="Chan`s Jupyter" />
<meta property="og:image" content="https://goodboychan.github.io/images/bucketing.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-08-11T00:00:00-05:00" />
<script type="application/ld+json">
{"url":"https://goodboychan.github.io/python/datacamp/pyspark/2020/08/11/01-Regression-in-PySpark.html","@type":"BlogPosting","headline":"Regression in PySpark","dateModified":"2020-08-11T00:00:00-05:00","datePublished":"2020-08-11T00:00:00-05:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://goodboychan.github.io/python/datacamp/pyspark/2020/08/11/01-Regression-in-PySpark.html"},"image":"https://goodboychan.github.io/images/bucketing.png","author":{"@type":"Person","name":"Chanseok Kang"},"description":"Next you’ll learn to create Linear Regression models. You’ll also find out how to augment your data by engineering new predictors as well as a robust approach to selecting only the most relevant predictors. This is the Summary of lecture “Machine Learning with PySpark”, via datacamp.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://goodboychan.github.io/feed.xml" title="Chan`s Jupyter" /><!-- the google_analytics_id gets auto inserted from the config file -->



<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-33905785-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-33905785-1');
</script>


<link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>

<script data-ad-client="ca-pub-6747875619665490" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Chan`s Jupyter</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/book/">Book</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Regression in PySpark</h1><p class="page-description">Next you'll learn to create Linear Regression models. You'll also find out how to augment your data by engineering new predictors as well as a robust approach to selecting only the most relevant predictors. This is the Summary of lecture "Machine Learning with PySpark", via datacamp.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-08-11T00:00:00-05:00" itemprop="datePublished">
        Aug 11, 2020
      </time>• 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">Chanseok Kang</span></span>
       • <span class="read-time" title="Estimated read time">
    
    
      13 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#Python">Python</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#Datacamp">Datacamp</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#PySpark">PySpark</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-justify-center">
          <div class="px-2">

    <a href="https://github.com/goodboychan/goodboychan.github.io/tree/main/_notebooks/2020-08-11-01-Regression-in-PySpark.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/goodboychan/goodboychan.github.io/main?filepath=_notebooks%2F2020-08-11-01-Regression-in-PySpark.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/goodboychan/goodboychan.github.io/blob/main/_notebooks/2020-08-11-01-Regression-in-PySpark.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://deepnote.com/launch?url=https%3A%2F%2Fgithub.com%2Fgoodboychan%2Fgoodboychan.github.io%2Fblob%2Fmain%2F_notebooks%2F2020-08-11-01-Regression-in-PySpark.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/deepnote.svg" alt="Launch in Deepnote"/>
    </a>
</div>
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#One-Hot-Encoding">One-Hot Encoding </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Encoding-flight-origin">Encoding flight origin </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Regression">Regression </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Flight-duration-model---Just-distance">Flight duration model - Just distance </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Interpreting-the-coefficients">Interpreting the coefficients </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Flight-duration-model---Adding-origin-airport">Flight duration model - Adding origin airport </a></li>
<li class="toc-entry toc-h3"><a href="#Interpreting-coefficients">Interpreting coefficients </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Bucketing-&-Engineering">Bucketing &amp; Engineering </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Bucketing-departure-time">Bucketing departure time </a></li>
<li class="toc-entry toc-h3"><a href="#Flight-duration-model---Adding-departure-time">Flight duration model - Adding departure time </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Regularization">Regularization </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Flight-duration-model---More-features!">Flight duration model - More features! </a></li>
<li class="toc-entry toc-h3"><a href="#Flight-duration-model---Regularization!">Flight duration model - Regularization! </a></li>
</ul>
</li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2020-08-11-01-Regression-in-PySpark.ipynb
-->

<div class="container" id="notebook-container">
        
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pyspark</span>
<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="One-Hot-Encoding">
<a class="anchor" href="#One-Hot-Encoding" aria-hidden="true"><span class="octicon octicon-link"></span></a>One-Hot Encoding<a class="anchor-link" href="#One-Hot-Encoding"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Encoding-flight-origin">
<a class="anchor" href="#Encoding-flight-origin" aria-hidden="true"><span class="octicon octicon-link"></span></a>Encoding flight origin<a class="anchor-link" href="#Encoding-flight-origin"> </a>
</h3>
<p>The <code>org</code> column in the flights data is a categorical variable giving the airport from which a flight departs.</p>
<ul>
<li>ORD — O'Hare International Airport (Chicago)</li>
<li>SFO — San Francisco International Airport</li>
<li>JFK — John F Kennedy International Airport (New York)</li>
<li>LGA — La Guardia Airport (New York)</li>
<li>SMF — Sacramento</li>
<li>SJC — San Jose</li>
<li>TUS — Tucson International Airport</li>
<li>OGG — Kahului (Hawaii)</li>
</ul>
<p>Obviously this is only a small subset of airports. Nevertheless, since this is a categorical variable, it needs to be one-hot encoded before it can be used in a regression model.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s1">'local[*]'</span><span class="p">)</span><span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s1">'flights'</span><span class="p">)</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>

<span class="c1"># Read data from CSV file</span>
<span class="n">flights</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span><span class="s1">'./dataset/flights-larger.csv'</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">','</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inferSchema</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">nullValue</span><span class="o">=</span><span class="s1">'NA'</span><span class="p">)</span>

<span class="c1"># Get number of records</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"The data contain </span><span class="si">%d</span><span class="s2"> records."</span> <span class="o">%</span> <span class="n">flights</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>

<span class="c1"># View the first five records</span>
<span class="n">flights</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="c1"># Check column data types</span>
<span class="nb">print</span><span class="p">(</span><span class="n">flights</span><span class="o">.</span><span class="n">printSchema</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">flights</span><span class="o">.</span><span class="n">dtypes</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>The data contain 275000 records.
+---+---+---+-------+------+---+----+------+--------+-----+
|mon|dom|dow|carrier|flight|org|mile|depart|duration|delay|
+---+---+---+-------+------+---+----+------+--------+-----+
| 10| 10|  1|     OO|  5836|ORD| 157|  8.18|      51|   27|
|  1|  4|  1|     OO|  5866|ORD| 466|  15.5|     102| null|
| 11| 22|  1|     OO|  6016|ORD| 738|  7.17|     127|  -19|
|  2| 14|  5|     B6|   199|JFK|2248| 21.17|     365|   60|
|  5| 25|  3|     WN|  1675|SJC| 386| 12.92|      85|   22|
+---+---+---+-------+------+---+----+------+--------+-----+
only showing top 5 rows

root
 |-- mon: integer (nullable = true)
 |-- dom: integer (nullable = true)
 |-- dow: integer (nullable = true)
 |-- carrier: string (nullable = true)
 |-- flight: integer (nullable = true)
 |-- org: string (nullable = true)
 |-- mile: integer (nullable = true)
 |-- depart: double (nullable = true)
 |-- duration: integer (nullable = true)
 |-- delay: integer (nullable = true)

None
[('mon', 'int'), ('dom', 'int'), ('dow', 'int'), ('carrier', 'string'), ('flight', 'int'), ('org', 'string'), ('mile', 'int'), ('depart', 'double'), ('duration', 'int'), ('delay', 'int')]
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.ml.feature</span> <span class="kn">import</span> <span class="n">StringIndexer</span>

<span class="n">flights</span> <span class="o">=</span> <span class="n">StringIndexer</span><span class="p">(</span><span class="n">inputCol</span><span class="o">=</span><span class="s1">'org'</span><span class="p">,</span> <span class="n">outputCol</span><span class="o">=</span><span class="s1">'org_idx'</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">flights</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">flights</span><span class="p">)</span>

<span class="n">flights</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>+---+---+---+-------+------+---+----+------+--------+-----+-------+
|mon|dom|dow|carrier|flight|org|mile|depart|duration|delay|org_idx|
+---+---+---+-------+------+---+----+------+--------+-----+-------+
| 10| 10|  1|     OO|  5836|ORD| 157|  8.18|      51|   27|    0.0|
|  1|  4|  1|     OO|  5866|ORD| 466|  15.5|     102| null|    0.0|
| 11| 22|  1|     OO|  6016|ORD| 738|  7.17|     127|  -19|    0.0|
|  2| 14|  5|     B6|   199|JFK|2248| 21.17|     365|   60|    2.0|
|  5| 25|  3|     WN|  1675|SJC| 386| 12.92|      85|   22|    5.0|
|  3| 28|  1|     B6|   377|LGA|1076| 13.33|     182|   70|    3.0|
|  5| 28|  6|     B6|   904|ORD| 740|  9.58|     130|   47|    0.0|
|  1| 19|  2|     UA|   820|SFO| 679| 12.75|     123|  135|    1.0|
|  8|  5|  5|     US|  2175|LGA| 214|  13.0|      71|  -10|    3.0|
|  5| 27|  5|     AA|  1240|ORD|1197| 14.42|     195|  -11|    0.0|
|  8| 20|  6|     B6|   119|JFK|1182| 14.67|     198|   20|    2.0|
|  2|  3|  1|     AA|  1881|JFK|1090| 15.92|     200|   -9|    2.0|
|  8| 26|  5|     B6|    35|JFK|1028| 20.58|     193|  102|    2.0|
|  4|  9|  5|     AA|   336|ORD| 733|  20.5|     125|   32|    0.0|
|  3|  8|  2|     UA|   678|ORD| 733| 10.95|     129|   55|    0.0|
|  8| 10|  3|     OH|  6347|LGA| 292| 11.75|     102|    8|    3.0|
|  8| 14|  0|     UA|   624|ORD| 612| 17.92|     109|   57|    0.0|
|  4|  8|  4|     OH|  5585|JFK| 301| 13.25|      88|   23|    2.0|
|  1| 14|  4|     UA|  1524|SFO| 414| 14.87|      91|   27|    1.0|
|  1|  2|  6|     AA|  1341|ORD|1846|   7.5|     275|   26|    0.0|
+---+---+---+-------+------+---+----+------+--------+-----+-------+
only showing top 20 rows

</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p></p>
<div class="flash">
    <svg class="octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z"></path></svg>
    <strong>Note: </strong><code>OneHotEncoderEstimator</code> is replaced with <code>OneHotEncoder</code> in 3.0.0
</div>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.ml.feature</span> <span class="kn">import</span> <span class="n">OneHotEncoder</span>

<span class="c1"># Create an instance of the one hot encoder</span>
<span class="n">onehot</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">inputCols</span><span class="o">=</span><span class="p">[</span><span class="s1">'org_idx'</span><span class="p">],</span> <span class="n">outputCols</span><span class="o">=</span><span class="p">[</span><span class="s1">'org_dummy'</span><span class="p">])</span>

<span class="c1"># Apply the one hot encoder to the flights data</span>
<span class="n">onehot</span> <span class="o">=</span> <span class="n">onehot</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">flights</span><span class="p">)</span>
<span class="n">flights_onehot</span> <span class="o">=</span> <span class="n">onehot</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">flights</span><span class="p">)</span>

<span class="c1"># Check the results</span>
<span class="n">flights_onehot</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">'org'</span><span class="p">,</span> <span class="s1">'org_idx'</span><span class="p">,</span> <span class="s1">'org_dummy'</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s1">'org_idx'</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>+---+-------+-------------+
|org|org_idx|    org_dummy|
+---+-------+-------------+
|ORD|    0.0|(7,[0],[1.0])|
|SFO|    1.0|(7,[1],[1.0])|
|JFK|    2.0|(7,[2],[1.0])|
|LGA|    3.0|(7,[3],[1.0])|
|SMF|    4.0|(7,[4],[1.0])|
|SJC|    5.0|(7,[5],[1.0])|
|TUS|    6.0|(7,[6],[1.0])|
|OGG|    7.0|    (7,[],[])|
+---+-------+-------------+

</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Regression">
<a class="anchor" href="#Regression" aria-hidden="true"><span class="octicon octicon-link"></span></a>Regression<a class="anchor-link" href="#Regression"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Flight-duration-model---Just-distance">
<a class="anchor" href="#Flight-duration-model---Just-distance" aria-hidden="true"><span class="octicon octicon-link"></span></a>Flight duration model - Just distance<a class="anchor-link" href="#Flight-duration-model---Just-distance"> </a>
</h3>
<p>In this exercise you'll build a regression model to predict flight duration (the <code>duration</code> column).</p>
<p>For the moment you'll keep the model simple, including only the distance of the flight (the <code>km</code> column) as a predictor.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">flights_onehot</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>+---+---+---+-------+------+---+----+------+--------+-----+-------+-------------+
|mon|dom|dow|carrier|flight|org|mile|depart|duration|delay|org_idx|    org_dummy|
+---+---+---+-------+------+---+----+------+--------+-----+-------+-------------+
| 10| 10|  1|     OO|  5836|ORD| 157|  8.18|      51|   27|    0.0|(7,[0],[1.0])|
|  1|  4|  1|     OO|  5866|ORD| 466|  15.5|     102| null|    0.0|(7,[0],[1.0])|
| 11| 22|  1|     OO|  6016|ORD| 738|  7.17|     127|  -19|    0.0|(7,[0],[1.0])|
|  2| 14|  5|     B6|   199|JFK|2248| 21.17|     365|   60|    2.0|(7,[2],[1.0])|
|  5| 25|  3|     WN|  1675|SJC| 386| 12.92|      85|   22|    5.0|(7,[5],[1.0])|
+---+---+---+-------+------+---+----+------+--------+-----+-------+-------------+
only showing top 5 rows

</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="nb">round</span>

<span class="c1"># Convert 'mile' to 'km' and drop 'mile' column</span>
<span class="n">flights_onehot</span> <span class="o">=</span> <span class="n">flights_onehot</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">'km'</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">flights_onehot</span><span class="o">.</span><span class="n">mile</span> <span class="o">*</span> <span class="mf">1.60934</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">'mile'</span><span class="p">)</span>

<span class="n">flights_onehot</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>+---+---+---+-------+------+---+------+--------+-----+-------+-------------+------+
|mon|dom|dow|carrier|flight|org|depart|duration|delay|org_idx|    org_dummy|    km|
+---+---+---+-------+------+---+------+--------+-----+-------+-------------+------+
| 10| 10|  1|     OO|  5836|ORD|  8.18|      51|   27|    0.0|(7,[0],[1.0])| 253.0|
|  1|  4|  1|     OO|  5866|ORD|  15.5|     102| null|    0.0|(7,[0],[1.0])| 750.0|
| 11| 22|  1|     OO|  6016|ORD|  7.17|     127|  -19|    0.0|(7,[0],[1.0])|1188.0|
|  2| 14|  5|     B6|   199|JFK| 21.17|     365|   60|    2.0|(7,[2],[1.0])|3618.0|
|  5| 25|  3|     WN|  1675|SJC| 12.92|      85|   22|    5.0|(7,[5],[1.0])| 621.0|
+---+---+---+-------+------+---+------+--------+-----+-------+-------------+------+
only showing top 5 rows

</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.ml.feature</span> <span class="kn">import</span> <span class="n">VectorAssembler</span>

<span class="c1"># Create an assembler object</span>
<span class="n">assembler</span> <span class="o">=</span> <span class="n">VectorAssembler</span><span class="p">(</span><span class="n">inputCols</span><span class="o">=</span><span class="p">[</span><span class="s1">'km'</span><span class="p">],</span> <span class="n">outputCol</span><span class="o">=</span><span class="s1">'features'</span><span class="p">)</span>

<span class="c1"># Consolidate predictor columns</span>
<span class="n">flights</span> <span class="o">=</span> <span class="n">assembler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">flights_onehot</span><span class="p">)</span>

<span class="n">flights</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>+---+---+---+-------+------+---+------+--------+-----+-------+-------------+------+--------+
|mon|dom|dow|carrier|flight|org|depart|duration|delay|org_idx|    org_dummy|    km|features|
+---+---+---+-------+------+---+------+--------+-----+-------+-------------+------+--------+
| 10| 10|  1|     OO|  5836|ORD|  8.18|      51|   27|    0.0|(7,[0],[1.0])| 253.0| [253.0]|
|  1|  4|  1|     OO|  5866|ORD|  15.5|     102| null|    0.0|(7,[0],[1.0])| 750.0| [750.0]|
| 11| 22|  1|     OO|  6016|ORD|  7.17|     127|  -19|    0.0|(7,[0],[1.0])|1188.0|[1188.0]|
|  2| 14|  5|     B6|   199|JFK| 21.17|     365|   60|    2.0|(7,[2],[1.0])|3618.0|[3618.0]|
|  5| 25|  3|     WN|  1675|SJC| 12.92|      85|   22|    5.0|(7,[5],[1.0])| 621.0| [621.0]|
+---+---+---+-------+------+---+------+--------+-----+-------+-------------+------+--------+
only showing top 5 rows

</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">flights_train</span><span class="p">,</span> <span class="n">flights_test</span> <span class="o">=</span> <span class="n">flights</span><span class="o">.</span><span class="n">randomSplit</span><span class="p">([</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.ml.regression</span> <span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="kn">from</span> <span class="nn">pyspark.ml.evaluation</span> <span class="kn">import</span> <span class="n">RegressionEvaluator</span>

<span class="c1"># Create a regression object and train on training data</span>
<span class="n">regression</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">(</span><span class="n">featuresCol</span><span class="o">=</span><span class="s1">'features'</span><span class="p">,</span> <span class="n">labelCol</span><span class="o">=</span><span class="s1">'duration'</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">flights_train</span><span class="p">)</span>

<span class="c1"># Create predictions for the test data and take a look at the predictions</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">regression</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">flights_test</span><span class="p">)</span>
<span class="n">predictions</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">'duration'</span><span class="p">,</span> <span class="s1">'prediction'</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

<span class="c1"># Calculate the RMSE</span>
<span class="n">RegressionEvaluator</span><span class="p">(</span><span class="n">labelCol</span><span class="o">=</span><span class="s1">'duration'</span><span class="p">,</span> <span class="n">metricName</span><span class="o">=</span><span class="s1">'rmse'</span><span class="p">)</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>+--------+------------------+
|duration|prediction        |
+--------+------------------+
|420     |496.4735315834907 |
|379     |345.85941488647666|
|210     |222.65721887539473|
|164     |133.60633841501843|
|125     |133.60633841501843|
+--------+------------------+
only showing top 5 rows

</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>17.27005980968751</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Interpreting-the-coefficients">
<a class="anchor" href="#Interpreting-the-coefficients" aria-hidden="true"><span class="octicon octicon-link"></span></a>Interpreting the coefficients<a class="anchor-link" href="#Interpreting-the-coefficients"> </a>
</h2>
<p>The linear regression model for flight duration as a function of distance takes the form</p>
<p>duration = $\alpha$ + $\beta$ × distance</p>
<p>where</p>
<ul>
<li>$\alpha$ — intercept (component of duration which does not depend on distance) and</li>
<li>$\beta$ — coefficient (rate at which duration increases as a function of distance; also called the slope).</li>
</ul>
<p>By looking at the coefficients of your model you will be able to infer</p>
<ul>
<li>how much of the average flight duration is actually spent on the ground and</li>
<li>what the average speed is during a flight.</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">inter</span> <span class="o">=</span> <span class="n">regression</span><span class="o">.</span><span class="n">intercept</span>
<span class="nb">print</span><span class="p">(</span><span class="n">inter</span><span class="p">)</span>

<span class="c1"># Coefficients</span>
<span class="n">coefs</span> <span class="o">=</span> <span class="n">regression</span><span class="o">.</span><span class="n">coefficients</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coefs</span><span class="p">)</span>

<span class="c1"># Average minutes per km</span>
<span class="n">minutes_per_km</span> <span class="o">=</span> <span class="n">regression</span><span class="o">.</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">minutes_per_km</span><span class="p">)</span>

<span class="c1"># Average speed in km per hour</span>
<span class="n">avg_speed</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">/</span> <span class="n">minutes_per_km</span>
<span class="nb">print</span><span class="p">(</span><span class="n">avg_speed</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>44.25256380341634
[0.07572353780644245]
0.07572353780644245
792.3560063103033
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Flight-duration-model---Adding-origin-airport">
<a class="anchor" href="#Flight-duration-model---Adding-origin-airport" aria-hidden="true"><span class="octicon octicon-link"></span></a>Flight duration model - Adding origin airport<a class="anchor-link" href="#Flight-duration-model---Adding-origin-airport"> </a>
</h3>
<p>Some airports are busier than others. Some airports are bigger than others too. Flights departing from large or busy airports are likely to spend more time taxiing or waiting for their takeoff slot. So it stands to reason that the duration of a flight might depend not only on the distance being covered but also the airport from which the flight departs.</p>
<p>You are going to make the regression model a little more sophisticated by including the departure airport as a predictor.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">assembler</span> <span class="o">=</span> <span class="n">VectorAssembler</span><span class="p">(</span><span class="n">inputCols</span><span class="o">=</span><span class="p">[</span><span class="s1">'km'</span><span class="p">,</span> <span class="s1">'org_dummy'</span><span class="p">],</span> <span class="n">outputCol</span><span class="o">=</span><span class="s1">'features'</span><span class="p">)</span>

<span class="c1"># Consolidate predictor columns</span>
<span class="n">flights</span> <span class="o">=</span> <span class="n">assembler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">flights_onehot</span><span class="p">)</span>

<span class="n">flights</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>+---+---+---+-------+------+---+------+--------+-----+-------+-------------+------+--------------------+
|mon|dom|dow|carrier|flight|org|depart|duration|delay|org_idx|    org_dummy|    km|            features|
+---+---+---+-------+------+---+------+--------+-----+-------+-------------+------+--------------------+
| 10| 10|  1|     OO|  5836|ORD|  8.18|      51|   27|    0.0|(7,[0],[1.0])| 253.0|(8,[0,1],[253.0,1...|
|  1|  4|  1|     OO|  5866|ORD|  15.5|     102| null|    0.0|(7,[0],[1.0])| 750.0|(8,[0,1],[750.0,1...|
| 11| 22|  1|     OO|  6016|ORD|  7.17|     127|  -19|    0.0|(7,[0],[1.0])|1188.0|(8,[0,1],[1188.0,...|
|  2| 14|  5|     B6|   199|JFK| 21.17|     365|   60|    2.0|(7,[2],[1.0])|3618.0|(8,[0,3],[3618.0,...|
|  5| 25|  3|     WN|  1675|SJC| 12.92|      85|   22|    5.0|(7,[5],[1.0])| 621.0|(8,[0,6],[621.0,1...|
+---+---+---+-------+------+---+------+--------+-----+-------+-------------+------+--------------------+
only showing top 5 rows

</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">flights_train</span><span class="p">,</span> <span class="n">flights_test</span> <span class="o">=</span> <span class="n">flights</span><span class="o">.</span><span class="n">randomSplit</span><span class="p">([</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>

<span class="c1"># Create a regression object and train on training data</span>
<span class="n">regression</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">(</span><span class="n">featuresCol</span><span class="o">=</span><span class="s1">'features'</span><span class="p">,</span> <span class="n">labelCol</span><span class="o">=</span><span class="s1">'duration'</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">flights_train</span><span class="p">)</span>

<span class="c1"># Create predictions for the test data</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">regression</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">flights_test</span><span class="p">)</span>

<span class="c1"># Calculate the RMSE on test data</span>
<span class="n">RegressionEvaluator</span><span class="p">(</span><span class="n">labelCol</span><span class="o">=</span><span class="s1">'duration'</span><span class="p">,</span> <span class="n">metricName</span><span class="o">=</span><span class="s1">'rmse'</span><span class="p">)</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>11.068844362217451</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Interpreting-coefficients">
<a class="anchor" href="#Interpreting-coefficients" aria-hidden="true"><span class="octicon octicon-link"></span></a>Interpreting coefficients<a class="anchor-link" href="#Interpreting-coefficients"> </a>
</h3>
<p>Remember that origin airport, <code>org</code>, has eight possible values (ORD, SFO, JFK, LGA, SMF, SJC, TUS and OGG) which have been one-hot encoded to seven dummy variables in <code>org_dummy</code>.</p>
<p>The values for <code>km</code> and <code>org_dummy</code> have been assembled into features, which has eight columns with sparse representation. Column indices in features are as follows:</p>
<ul>
<li>0 — <code>km</code>
</li>
<li>1 — <code>ORD</code>
</li>
<li>2 — <code>SFO</code>
</li>
<li>3 — <code>JFK</code>
</li>
<li>4 — <code>LGA</code>
</li>
<li>5 — <code>SMF</code>
</li>
<li>6 — <code>SJC</code> and</li>
<li>7 — <code>TUS</code>.
Note that <code>OGG</code> does not appear in this list because it is the reference level for the origin airport category.</li>
</ul>
<p>In this exercise you'll be using the <code>intercept</code> and <code>coefficients</code> attributes to interpret the model.</p>
<p>The <code>coefficients</code> attribute is a list, where the first element indicates how flight duration changes with flight distance.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">avg_speed_hour</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">/</span> <span class="n">regression</span><span class="o">.</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">avg_speed_hour</span><span class="p">)</span>

<span class="c1"># Averate minutes on ground at OGG</span>
<span class="n">inter</span> <span class="o">=</span> <span class="n">regression</span><span class="o">.</span><span class="n">intercept</span>
<span class="nb">print</span><span class="p">(</span><span class="n">inter</span><span class="p">)</span>

<span class="c1"># Average minutes on ground at JFK</span>
<span class="n">avg_ground_jfk</span><span class="o">=</span> <span class="n">inter</span> <span class="o">+</span> <span class="n">regression</span><span class="o">.</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">avg_ground_jfk</span><span class="p">)</span>

<span class="c1"># Average minutes on ground at LGA</span>
<span class="n">avg_ground_lga</span> <span class="o">=</span> <span class="n">inter</span> <span class="o">+</span> <span class="n">regression</span><span class="o">.</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">avg_ground_lga</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>807.3348263721097
16.056291454658716
68.7530254980533
62.839478468083115
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Bucketing-&amp;-Engineering">
<a class="anchor" href="#Bucketing-&amp;-Engineering" aria-hidden="true"><span class="octicon octicon-link"></span></a>Bucketing &amp; Engineering<a class="anchor-link" href="#Bucketing-&amp;-Engineering"> </a>
</h2>
<ul>
<li>Bucketing
<img src="/images/copied_from_nb/image/bucketing.png" alt="bucket">
</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Bucketing-departure-time">
<a class="anchor" href="#Bucketing-departure-time" aria-hidden="true"><span class="octicon octicon-link"></span></a>Bucketing departure time<a class="anchor-link" href="#Bucketing-departure-time"> </a>
</h3>
<p>Time of day data are a challenge with regression models. They are also a great candidate for bucketing.</p>
<p>In this lesson you will convert the flight departure times from numeric values between 0 (corresponding to "00:00") and 24 (corresponding to "24:00") to binned values. You'll then take those binned values and one-hot encode them.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.ml.feature</span> <span class="kn">import</span> <span class="n">Bucketizer</span>

<span class="c1"># Create buckets at 3 hour intervals through the day</span>
<span class="n">buckets</span> <span class="o">=</span> <span class="n">Bucketizer</span><span class="p">(</span><span class="n">splits</span><span class="o">=</span><span class="p">[</span>
    <span class="mi">3</span> <span class="o">*</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
<span class="p">],</span> <span class="n">inputCol</span><span class="o">=</span><span class="s1">'depart'</span><span class="p">,</span> <span class="n">outputCol</span><span class="o">=</span><span class="s1">'depart_bucket'</span><span class="p">)</span>

<span class="c1"># Bucket the departure times</span>
<span class="n">bucketed</span> <span class="o">=</span> <span class="n">buckets</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">flights</span><span class="p">)</span>
<span class="n">bucketed</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">'depart'</span><span class="p">,</span> <span class="s1">'depart_bucket'</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="c1"># Create a one-hot encoder</span>
<span class="n">onehot</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">inputCols</span><span class="o">=</span><span class="p">[</span><span class="s1">'depart_bucket'</span><span class="p">],</span> <span class="n">outputCols</span><span class="o">=</span><span class="p">[</span><span class="s1">'depart_dummy'</span><span class="p">])</span>

<span class="c1"># One-hot encode the bucketed departure times</span>
<span class="n">flights_onehot</span> <span class="o">=</span> <span class="n">onehot</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">bucketed</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">bucketed</span><span class="p">)</span>
<span class="n">flights_onehot</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">'depart'</span><span class="p">,</span> <span class="s1">'depart_bucket'</span><span class="p">,</span> <span class="s1">'depart_dummy'</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>+------+-------------+
|depart|depart_bucket|
+------+-------------+
|  8.18|          2.0|
|  15.5|          5.0|
|  7.17|          2.0|
| 21.17|          7.0|
| 12.92|          4.0|
+------+-------------+
only showing top 5 rows

+------+-------------+-------------+
|depart|depart_bucket| depart_dummy|
+------+-------------+-------------+
|  8.18|          2.0|(7,[2],[1.0])|
|  15.5|          5.0|(7,[5],[1.0])|
|  7.17|          2.0|(7,[2],[1.0])|
| 21.17|          7.0|    (7,[],[])|
| 12.92|          4.0|(7,[4],[1.0])|
+------+-------------+-------------+
only showing top 5 rows

</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Flight-duration-model---Adding-departure-time">
<a class="anchor" href="#Flight-duration-model---Adding-departure-time" aria-hidden="true"><span class="octicon octicon-link"></span></a>Flight duration model - Adding departure time<a class="anchor-link" href="#Flight-duration-model---Adding-departure-time"> </a>
</h3>
<p>In the previous exercise the departure time was bucketed and converted to dummy variables. Now you're going to include those dummy variables in a regression model for flight duration.</p>
<p>The data are in <code>flights</code>. The <code>km</code>, <code>org_dummy</code> and <code>depart_dummy</code> columns have been assembled into <code>features</code>, where <code>km</code> is index 0, <code>org_dummy</code> runs from index 1 to 7 and <code>depart_dummy</code> from index 8 to 14.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">assembler</span> <span class="o">=</span> <span class="n">VectorAssembler</span><span class="p">(</span><span class="n">inputCols</span><span class="o">=</span><span class="p">[</span><span class="s1">'km'</span><span class="p">,</span> <span class="s1">'org_dummy'</span><span class="p">,</span> <span class="s1">'depart_dummy'</span><span class="p">],</span> <span class="n">outputCol</span><span class="o">=</span><span class="s1">'features'</span><span class="p">)</span>

<span class="n">flights</span> <span class="o">=</span> <span class="n">assembler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">flights_onehot</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">'features'</span><span class="p">))</span>

<span class="n">flights</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>+---+---+---+-------+------+---+------+--------+-----+-------+-------------+------+-------------+-------------+--------------------+
|mon|dom|dow|carrier|flight|org|depart|duration|delay|org_idx|    org_dummy|    km|depart_bucket| depart_dummy|            features|
+---+---+---+-------+------+---+------+--------+-----+-------+-------------+------+-------------+-------------+--------------------+
| 10| 10|  1|     OO|  5836|ORD|  8.18|      51|   27|    0.0|(7,[0],[1.0])| 253.0|          2.0|(7,[2],[1.0])|(15,[0,1,10],[253...|
|  1|  4|  1|     OO|  5866|ORD|  15.5|     102| null|    0.0|(7,[0],[1.0])| 750.0|          5.0|(7,[5],[1.0])|(15,[0,1,13],[750...|
| 11| 22|  1|     OO|  6016|ORD|  7.17|     127|  -19|    0.0|(7,[0],[1.0])|1188.0|          2.0|(7,[2],[1.0])|(15,[0,1,10],[118...|
|  2| 14|  5|     B6|   199|JFK| 21.17|     365|   60|    2.0|(7,[2],[1.0])|3618.0|          7.0|    (7,[],[])|(15,[0,3],[3618.0...|
|  5| 25|  3|     WN|  1675|SJC| 12.92|      85|   22|    5.0|(7,[5],[1.0])| 621.0|          4.0|(7,[4],[1.0])|(15,[0,6,12],[621...|
+---+---+---+-------+------+---+------+--------+-----+-------+-------------+------+-------------+-------------+--------------------+
only showing top 5 rows

</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">flights_train</span><span class="p">,</span> <span class="n">flights_test</span> <span class="o">=</span> <span class="n">flights</span><span class="o">.</span><span class="n">randomSplit</span><span class="p">([</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>

<span class="c1"># Train with training data</span>
<span class="n">regression</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">(</span><span class="n">labelCol</span><span class="o">=</span><span class="s1">'duration'</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">flights_train</span><span class="p">)</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">regression</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">flights_test</span><span class="p">)</span>

<span class="n">RegressionEvaluator</span><span class="p">(</span><span class="n">labelCol</span><span class="o">=</span><span class="s1">'duration'</span><span class="p">,</span> <span class="n">metricName</span><span class="o">=</span><span class="s1">'rmse'</span><span class="p">)</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>

<span class="c1"># Average minutes on ground at OGG for flights departing between 21:00 and 24:00</span>
<span class="n">avg_eve_ogg</span> <span class="o">=</span> <span class="n">regression</span><span class="o">.</span><span class="n">intercept</span>
<span class="nb">print</span><span class="p">(</span><span class="n">avg_eve_ogg</span><span class="p">)</span>

<span class="c1"># Average minutes on ground at OGG for flights departing between 00:00 and 03:00</span>
<span class="n">avg_night_ogg</span> <span class="o">=</span> <span class="n">regression</span><span class="o">.</span><span class="n">intercept</span> <span class="o">+</span> <span class="n">regression</span><span class="o">.</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">avg_night_ogg</span><span class="p">)</span>

<span class="c1"># Average minutes on ground at JFK for flights departing between 00:00 and 03:00</span>
<span class="n">avg_night_jfk</span> <span class="o">=</span> <span class="n">regression</span><span class="o">.</span><span class="n">intercept</span> <span class="o">+</span> <span class="n">regression</span><span class="o">.</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">regression</span><span class="o">.</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">avg_night_jfk</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>10.373606920439098
-4.299103533053989
47.724554377263395
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Regularization">
<a class="anchor" href="#Regularization" aria-hidden="true"><span class="octicon octicon-link"></span></a>Regularization<a class="anchor-link" href="#Regularization"> </a>
</h2>
<ul>
<li>Feature Selection
<img src="/images/copied_from_nb/image/feature_selection.png" alt="fs">
</li>
<li>Loss function<ul>
<li>Linear regression aims to minimize the MSE

$$ MSE = \frac{1}{N} \sum_{i=1}^{N}(y_i - \hat{y_i})^2 $$
</li>
</ul>
</li>
<li>Loss function with regularization<ul>
<li>Add a regularization term which depends on coefficients

$$ MSE = \frac{1}{N} \sum_{i=1}^{N}(y_i - \hat{y_i})^2 + \lambda f(\beta) $$
</li>
<li>Regularizer<ul>
<li>Lasso - absolute value of the coefficients</li>
<li>Ridge - square of the coefficients</li>
</ul>
</li>
<li>Both will shrink the coefficients of unimportant predictors</li>
<li>Strength of regularization determined by parameter $\lambda$:<ul>
<li>$\lambda = 0$ - no regularization (standard regression)</li>
<li>$\lambda = \infty$ - complete regularization (all coefficients zero)</li>
</ul>
</li>
</ul>
</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Flight-duration-model---More-features!">
<a class="anchor" href="#Flight-duration-model---More-features!" aria-hidden="true"><span class="octicon octicon-link"></span></a>Flight duration model - More features!<a class="anchor-link" href="#Flight-duration-model---More-features!"> </a>
</h3>
<p>Let's add more features to our model. This will not necessarily result in a better model. Adding some features might improve the model. Adding other features might make it worse.</p>
<p>More features will always make the model more complicated and difficult to interpret.</p>
<p>These are the features you'll include in the next model:</p>
<ul>
<li><code>km</code></li>
<li>
<code>org</code> (origin airport, one-hot encoded, 8 levels)</li>
<li>
<code>depart</code> (departure time, binned in 3 hour intervals, one-hot encoded, 8 levels)</li>
<li>
<code>dow</code> (departure day of week, one-hot encoded, 7 levels) and</li>
<li>
<code>mon</code> (departure month, one-hot encoded, 12 levels).</li>
</ul>
<p>These have been assembled into the <code>features</code> column, which is a sparse representation of 32 columns (remember one-hot encoding produces a number of columns which is one fewer than the number of levels).</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">onehot</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">inputCols</span><span class="o">=</span><span class="p">[</span><span class="s1">'dow'</span><span class="p">],</span> <span class="n">outputCols</span><span class="o">=</span><span class="p">[</span><span class="s1">'dow_dummy'</span><span class="p">])</span>
<span class="n">flights</span> <span class="o">=</span> <span class="n">onehot</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">flights</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">flights</span><span class="p">)</span>

<span class="n">onehot</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">inputCols</span><span class="o">=</span><span class="p">[</span><span class="s1">'mon'</span><span class="p">],</span> <span class="n">outputCols</span><span class="o">=</span><span class="p">[</span><span class="s1">'mon_dummy'</span><span class="p">])</span>
<span class="n">flights</span> <span class="o">=</span> <span class="n">onehot</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">flights</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">flights</span><span class="p">)</span>

<span class="n">flights</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>+---+---+---+-------+------+---+------+--------+-----+-------+-------------+------+-------------+-------------+--------------------+-------------+---------------+
|mon|dom|dow|carrier|flight|org|depart|duration|delay|org_idx|    org_dummy|    km|depart_bucket| depart_dummy|            features|    dow_dummy|      mon_dummy|
+---+---+---+-------+------+---+------+--------+-----+-------+-------------+------+-------------+-------------+--------------------+-------------+---------------+
| 10| 10|  1|     OO|  5836|ORD|  8.18|      51|   27|    0.0|(7,[0],[1.0])| 253.0|          2.0|(7,[2],[1.0])|(15,[0,1,10],[253...|(6,[1],[1.0])|(11,[10],[1.0])|
|  1|  4|  1|     OO|  5866|ORD|  15.5|     102| null|    0.0|(7,[0],[1.0])| 750.0|          5.0|(7,[5],[1.0])|(15,[0,1,13],[750...|(6,[1],[1.0])| (11,[1],[1.0])|
| 11| 22|  1|     OO|  6016|ORD|  7.17|     127|  -19|    0.0|(7,[0],[1.0])|1188.0|          2.0|(7,[2],[1.0])|(15,[0,1,10],[118...|(6,[1],[1.0])|     (11,[],[])|
|  2| 14|  5|     B6|   199|JFK| 21.17|     365|   60|    2.0|(7,[2],[1.0])|3618.0|          7.0|    (7,[],[])|(15,[0,3],[3618.0...|(6,[5],[1.0])| (11,[2],[1.0])|
|  5| 25|  3|     WN|  1675|SJC| 12.92|      85|   22|    5.0|(7,[5],[1.0])| 621.0|          4.0|(7,[4],[1.0])|(15,[0,6,12],[621...|(6,[3],[1.0])| (11,[5],[1.0])|
+---+---+---+-------+------+---+------+--------+-----+-------+-------------+------+-------------+-------------+--------------------+-------------+---------------+
only showing top 5 rows

</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">assembler</span> <span class="o">=</span> <span class="n">VectorAssembler</span><span class="p">(</span><span class="n">inputCols</span><span class="o">=</span><span class="p">[</span>
    <span class="s1">'km'</span><span class="p">,</span> <span class="s1">'org_dummy'</span><span class="p">,</span> <span class="s1">'depart_dummy'</span><span class="p">,</span> <span class="s1">'dow_dummy'</span><span class="p">,</span> <span class="s1">'mon_dummy'</span>
<span class="p">],</span> <span class="n">outputCol</span><span class="o">=</span><span class="s1">'features'</span><span class="p">)</span>

<span class="n">flights</span> <span class="o">=</span> <span class="n">assembler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">flights</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">'features'</span><span class="p">))</span>
<span class="n">flights</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>+---+---+---+-------+------+---+------+--------+-----+-------+-------------+------+-------------+-------------+-------------+---------------+--------------------+
|mon|dom|dow|carrier|flight|org|depart|duration|delay|org_idx|    org_dummy|    km|depart_bucket| depart_dummy|    dow_dummy|      mon_dummy|            features|
+---+---+---+-------+------+---+------+--------+-----+-------+-------------+------+-------------+-------------+-------------+---------------+--------------------+
| 10| 10|  1|     OO|  5836|ORD|  8.18|      51|   27|    0.0|(7,[0],[1.0])| 253.0|          2.0|(7,[2],[1.0])|(6,[1],[1.0])|(11,[10],[1.0])|(32,[0,1,10,16,31...|
|  1|  4|  1|     OO|  5866|ORD|  15.5|     102| null|    0.0|(7,[0],[1.0])| 750.0|          5.0|(7,[5],[1.0])|(6,[1],[1.0])| (11,[1],[1.0])|(32,[0,1,13,16,22...|
| 11| 22|  1|     OO|  6016|ORD|  7.17|     127|  -19|    0.0|(7,[0],[1.0])|1188.0|          2.0|(7,[2],[1.0])|(6,[1],[1.0])|     (11,[],[])|(32,[0,1,10,16],[...|
|  2| 14|  5|     B6|   199|JFK| 21.17|     365|   60|    2.0|(7,[2],[1.0])|3618.0|          7.0|    (7,[],[])|(6,[5],[1.0])| (11,[2],[1.0])|(32,[0,3,20,23],[...|
|  5| 25|  3|     WN|  1675|SJC| 12.92|      85|   22|    5.0|(7,[5],[1.0])| 621.0|          4.0|(7,[4],[1.0])|(6,[3],[1.0])| (11,[5],[1.0])|(32,[0,6,12,18,26...|
+---+---+---+-------+------+---+------+--------+-----+-------+-------------+------+-------------+-------------+-------------+---------------+--------------------+
only showing top 5 rows

</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">flights_train</span><span class="p">,</span> <span class="n">flights_test</span> <span class="o">=</span> <span class="n">flights</span><span class="o">.</span><span class="n">randomSplit</span><span class="p">([</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>

<span class="c1"># Fit linear regressino model to training data</span>
<span class="n">regression</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">(</span><span class="n">labelCol</span><span class="o">=</span><span class="s1">'duration'</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">flights_train</span><span class="p">)</span>

<span class="c1"># Make predictions on test data</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">regression</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">flights_test</span><span class="p">)</span>

<span class="c1"># Calculate the RMSE on test data</span>
<span class="n">rmse</span> <span class="o">=</span> <span class="n">RegressionEvaluator</span><span class="p">(</span><span class="n">labelCol</span><span class="o">=</span><span class="s1">'duration'</span><span class="p">,</span> <span class="n">metricName</span><span class="o">=</span><span class="s1">'rmse'</span><span class="p">)</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"The test RMSE is"</span><span class="p">,</span> <span class="n">rmse</span><span class="p">)</span>

<span class="c1"># Look at the model coefficients</span>
<span class="n">coeffs</span> <span class="o">=</span> <span class="n">regression</span><span class="o">.</span><span class="n">coefficients</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coeffs</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>The test RMSE is 10.819088448211174
[0.07439903800595218,27.088541106962648,20.013200394243466,52.01818052724308,46.01830850977673,15.12491382457755,17.232738296408332,17.325183703296005,-14.71676008382402,-0.07217427091906863,4.005627327038735,7.010732946075667,4.716908120668705,8.858558301158828,8.985587137355129,-0.061725588783170936,-0.13593336494158573,-0.13496036395705654,-0.1433810465959523,-0.0442906254733511,-0.112404653935452,-1.8896756270865185,-1.8943555316508267,-1.9673036696221473,-3.395290942653575,-4.020286290569159,-3.830521589483759,-3.9812556715824035,-4.012225573392499,-3.8464412463732764,-2.630301804480476,-0.41142966468087394]
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Flight-duration-model---Regularization!">
<a class="anchor" href="#Flight-duration-model---Regularization!" aria-hidden="true"><span class="octicon octicon-link"></span></a>Flight duration model - Regularization!<a class="anchor-link" href="#Flight-duration-model---Regularization!"> </a>
</h3>
<p>In the previous exercise you added more predictors to the flight duration model. The model performed well on testing data, but with so many coefficients it was difficult to interpret.</p>
<p>In this exercise you'll use Lasso regression (regularized with a L1 penalty) to create a more parsimonious model. Many of the coefficients in the resulting model will be set to zero. This means that only a subset of the predictors actually contribute to the model. Despite the simpler model, it still produces a good RMSE on the testing data.</p>
<p>You'll use a specific value for the regularization strength. Later you'll learn how to find the best value using cross validation.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">regression</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">(</span><span class="n">labelCol</span><span class="o">=</span><span class="s1">'duration'</span><span class="p">,</span> <span class="n">regParam</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">elasticNetParam</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">flights_train</span><span class="p">)</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">regression</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">flights_test</span><span class="p">)</span>

<span class="c1"># Calculate the RMSE on testing data</span>
<span class="n">rmse</span> <span class="o">=</span> <span class="n">RegressionEvaluator</span><span class="p">(</span><span class="n">labelCol</span><span class="o">=</span><span class="s1">'duration'</span><span class="p">,</span> <span class="n">metricName</span><span class="o">=</span><span class="s1">'rmse'</span><span class="p">)</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"The test RMSE is"</span><span class="p">,</span> <span class="n">rmse</span><span class="p">)</span>

<span class="c1"># Look at the model coefficients</span>
<span class="n">coeffs</span> <span class="o">=</span> <span class="n">regression</span><span class="o">.</span><span class="n">coefficients</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coeffs</span><span class="p">)</span>

<span class="c1"># Number of zero coefficients</span>
<span class="n">zero_coeff</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">beta</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">beta</span> <span class="ow">in</span> <span class="n">regression</span><span class="o">.</span><span class="n">coefficients</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Number of coefficients equal to 0:"</span><span class="p">,</span> <span class="n">zero_coeff</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>The test RMSE is 11.755155956333065
[0.07355997996294984,5.410341029649853,0.0,29.289003982755304,22.26237552623214,-2.1151843901573755,0.0,0.0,0.0,0.0,0.0,0.0,0.0,1.0987079734966165,1.3500916409600519,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0]
Number of coefficients equal to 0: 25
</pre>
</div>
</div>

</div>
</div>

</div>
    

</div>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="goodboychan/goodboychan.github.io"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/python/datacamp/pyspark/2020/08/11/01-Regression-in-PySpark.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>An easy to use blogging platform with support for Jupyter Notebooks.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/goodboychan" target="_blank" title="goodboychan"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://www.linkedin.com/in/chanseokk" target="_blank" title="chanseokk"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg></a></li><li><a rel="me" href="https://twitter.com/fastdotai" target="_blank" title="fastdotai"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
